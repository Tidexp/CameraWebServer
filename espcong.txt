#include <WiFi.h>              // Th∆∞ vi·ªán qu·∫£n l√Ω k·∫øt n·ªëi WiFi
#include <esp_http_server.h>   // Th∆∞ vi·ªán t·∫°o m√°y ch·ªß HTTP tr√™n ESP32
#include <ESP32Servo.h>        // Th∆∞ vi·ªán ƒëi·ªÅu khi·ªÉn Servo

// ================== WiFi ==================
const char* ssid = "";    // T√™n m·∫°ng WiFi
const char* password = "";  // M·∫≠t kh·∫©u WiFi

// ================== Servo m·ªü c·ª≠a ==================
#define SERVO_PIN_1 13         // Ch√¢n ƒëi·ªÅu khi·ªÉn Servo 1
#define SERVO_PIN_2 12         // Ch√¢n ƒëi·ªÅu khi·ªÉn Servo 2
#define UNLOCK_DURATION 2000   // Th·ªùi gian m·ªü c·ª≠a (ms)

Servo servo1;                  // ƒê·ªëi t∆∞·ª£ng Servo 1
Servo servo2;                  // ƒê·ªëi t∆∞·ª£ng Servo 2

// ================== L298N Motor Driver ==================
#define IN1 26                 // Ch√¢n ƒëi·ªÅu khi·ªÉn motor L298N (Chi·ªÅu 1)
#define IN2 25                 // Ch√¢n ƒëi·ªÅu khi·ªÉn motor L298N (Chi·ªÅu 2)

// ================== C·∫£m bi·∫øn m∆∞a ==================
#define RAIN_SENSOR_PIN 34     // Ch√¢n Analog/Digital ƒë·ªçc t√≠n hi·ªáu c·∫£m bi·∫øn m∆∞a

// Tr·∫°ng th√°i gi√†n ph∆°i
bool roofIsRetracted = false; // true = ƒë√£ k√©o v√†o, false = ƒë√£ k√©o ra

// ================== HTTP server handle ==================
httpd_handle_t server = NULL; // Bi·∫øn x·ª≠ l√Ω cho m√°y ch·ªß HTTP

// ================== H√†m m·ªü c·ª≠a ==================
void triggerDoor() {
    Serial.println("üö™ M·ªü 2 servo...");
    servo1.write(90);  // M·ªü Servo
    servo2.write(90);
    delay(UNLOCK_DURATION);
    servo1.write(0);   // ƒê√≥ng Servo
    servo2.write(0);
    Serial.println("‚úì C·ª≠a ƒë√£ ƒë√≥ng l·∫°i");
}

// ================== H√†m ƒëi·ªÅu khi·ªÉn gi√†n ph∆°i ==================
void retractRoof() {
    if (!roofIsRetracted) {
        Serial.println("üåßÔ∏è M∆∞a - K√©o gi√†n ph∆°i v√†o...");
        digitalWrite(IN1, HIGH); // K√≠ch ho·∫°t motor k√©o v√†o
        digitalWrite(IN2, LOW);
        delay(5000);             // Th·ªùi gian k√©o v√†o
        digitalWrite(IN1, LOW);  // D·ª´ng motor
        digitalWrite(IN2, LOW);
        roofIsRetracted = true;
        Serial.println("‚úÖ Gi√†n ph∆°i ƒë√£ k√©o v√†o");
    }
}

void extendRoof() {
    if (roofIsRetracted) {
        Serial.println("‚òÄÔ∏è T·∫°nh m∆∞a - K√©o gi√†n ph∆°i ra...");
        digitalWrite(IN1, LOW);
        digitalWrite(IN2, HIGH); // K√≠ch ho·∫°t motor k√©o ra
        delay(5000);             // Th·ªùi gian k√©o ra
        digitalWrite(IN1, LOW);  // D·ª´ng motor
        digitalWrite(IN2, LOW);
        roofIsRetracted = false;
        Serial.println("‚úÖ Gi√†n ph∆°i ƒë√£ k√©o ra");
    }
}

// ================== HTTP handlers ==================
// X·ª≠ l√Ω y√™u c·∫ßu m·ªü c·ª≠a qua HTTP
static esp_err_t open_door_handler(httpd_req_t *req) {
    Serial.println("üì® Nh·∫≠n y√™u c·∫ßu m·ªü c·ª≠a");
    triggerDoor(); // G·ªçi h√†m m·ªü c·ª≠a
    const char response[] = "door_opened";
    httpd_resp_set_type(req, "text/plain");
    httpd_resp_set_hdr(req, "Access-Control-Allow-Origin", "*");
    return httpd_resp_send(req, response, strlen(response));
}

// X·ª≠ l√Ω y√™u c·∫ßu l·∫•y tr·∫°ng th√°i thi·∫øt b·ªã
static esp_err_t status_handler(httpd_req_t *req) {
    const char response[] = "{\"status\":\"door_esp_online\"}";
    httpd_resp_set_type(req, "application/json");
    httpd_resp_set_hdr(req, "Access-Control-Allow-Origin", "*");
    return httpd_resp_send(req, response, strlen(response));
}

// ================== WiFi ==================
void initWiFi() {
    Serial.print("Connecting to WiFi: ");
    Serial.println(ssid);
    WiFi.begin(ssid, password);
    int attempts = 0;
    while (WiFi.status() != WL_CONNECTED && attempts < 20) {
        delay(500);
        Serial.print(".");
        attempts++;
    }
    if (WiFi.status() == WL_CONNECTED) {
        Serial.println("\n‚úì WiFi connected!");
        Serial.print("IP: ");
        Serial.println(WiFi.localIP());
    } else {
        Serial.println("\n‚úó Failed to connect to WiFi");
    }
}

// ================== HTTP Server ==================
void startServer() {
    httpd_config_t config = HTTPD_DEFAULT_CONFIG(); // C·∫•u h√¨nh server m·∫∑c ƒë·ªãnh
    config.server_port = 80;

    Serial.printf("Starting HTTP server on port %d\n", config.server_port);

    if (httpd_start(&server, &config) != ESP_OK) {
        Serial.println("Failed to start server");
        return;
    }

    // ƒê·ªãnh nghƒ©a v√† ƒëƒÉng k√Ω URI cho l·ªánh m·ªü c·ª≠a
    httpd_uri_t open_door_uri = {
        .uri = "/open_door",
        .method = HTTP_GET,
        .handler = open_door_handler,
        .user_ctx = NULL};

    // ƒê·ªãnh nghƒ©a v√† ƒëƒÉng k√Ω URI cho tr·∫°ng th√°i
    httpd_uri_t status_uri = {
        .uri = "/status",
        .method = HTTP_GET,
        .handler = status_handler,
        .user_ctx = NULL};

    httpd_register_uri_handler(server, &open_door_uri);
    httpd_register_uri_handler(server, &status_uri);

    Serial.println("‚úì HTTP server started successfully");
    Serial.println("Endpoints:");
    Serial.println("  GET /open_door  - M·ªü c·ª≠a");
    Serial.println("  GET /status     - Tr·∫°ng th√°i");
}

// ================== SETUP ==================
void setup() {
    Serial.begin(115200);
    delay(1000);

    Serial.println("\n=== ESP32 Smart Door + Rain System ===");

    // C·∫•u h√¨nh Servo
    servo1.attach(SERVO_PIN_1); servo1.write(0);
    servo2.attach(SERVO_PIN_2); servo2.write(0);

    // C·∫•u h√¨nh Motor (L298N)
    pinMode(IN1, OUTPUT); digitalWrite(IN1, LOW);
    pinMode(IN2, OUTPUT); digitalWrite(IN2, LOW);

    // C·∫•u h√¨nh c·∫£m bi·∫øn m∆∞a
    pinMode(RAIN_SENSOR_PIN, INPUT);

    // Kh·ªüi t·∫°o WiFi v√† Server
    initWiFi();
    delay(1000);
    startServer();

    Serial.println("=== Setup Complete ===\n");
}

// ================== LOOP ==================
void loop() {
    // Ki·ªÉm tra v√† k·∫øt n·ªëi l·∫°i WiFi n·∫øu m·∫•t k·∫øt n·ªëi
    if (WiFi.status() != WL_CONNECTED) {
        Serial.println("WiFi disconnected, reconnecting...");
        WiFi.reconnect();
    }

    // ƒê·ªçc c·∫£m bi·∫øn m∆∞a
    int rainValue = digitalRead(RAIN_SENSOR_PIN);

    if (rainValue == LOW) { // N·∫øu tr·ªùi m∆∞a
        retractRoof(); // K√©o gi√†n ph∆°i v√†o
    } else { // N·∫øu tr·ªùi t·∫°nh
        extendRoof();  // K√©o gi√†n ph∆°i ra
    }

    delay(3000); // Ki·ªÉm tra m·ªói 3 gi√¢y
}